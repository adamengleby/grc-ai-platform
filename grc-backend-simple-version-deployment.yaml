location: australiasoutheast
name: grc-backend-simple
resourceGroup: rg-grc-ai-platform-syd
type: Microsoft.App/containerApps
properties:
  environmentId: /subscriptions/2e6b5431-6d83-4072-8ccc-86af69cf22b0/resourceGroups/rg-grc-ai-platform-syd/providers/Microsoft.App/managedEnvironments/grc-containerapp-env
  configuration:
    ingress:
      external: true
      targetPort: 8080
  template:
    containers:
    - name: grc-backend-simple
      image: mcr.microsoft.com/azure-functions/node:4-node20-appservice
      resources:
        cpu: 1.0
        memory: 2Gi
        ephemeralStorage: 4Gi
      env:
      - name: NODE_ENV
        value: "production"
      - name: PORT
        value: "8080"
      - name: POSTGRES_HOST
        value: "grc-postgres-syd.postgres.database.azure.com"
      - name: POSTGRES_DATABASE
        value: "grc_platform"
      - name: POSTGRES_USER
        value: "grcadmin"
      - name: POSTGRES_PASSWORD
        value: "GRC2024!Secure"
      - name: CORS_ORIGINS
        value: "https://grc-frontend-simple.calmmeadow-5080198e.australiasoutheast.azurecontainerapps.io,http://localhost:5173,*"
      command:
      - /bin/bash
      args:
      - -c
      - |
        set -e
        echo "ğŸš€ GRC AI Backend v1.1.0 - WITH VERSION FOOTER..."

        # Install required tools
        apt-get update -qq
        apt-get install -y git curl

        # Clone latest code
        echo "ğŸ“¥ Cloning latest backend code..."
        rm -rf /tmp/repo 2>/dev/null || true
        git clone --depth 1 https://github.com/adamengleby/grc-ai-platform.git /tmp/repo
        cd /tmp/repo

        echo "ğŸ“‹ Latest commit:"
        git log -1 --oneline

        # Set up production server
        echo "ğŸšš Setting up production backend with version footer..."
        mkdir -p /app
        cd /app

        # Copy the updated server file
        cp /tmp/repo/packages/backend/containerapp-server-v7.js server.js

        # Create production package.json
        cat > package.json << 'EOF'
        {
          "name": "grc-backend-simple",
          "version": "1.1.0",
          "main": "server.js",
          "dependencies": {
            "express": "^4.19.2",
            "cors": "^2.8.5",
            "pg": "^8.11.0"
          }
        }
        EOF

        echo "ğŸ“¦ Installing dependencies..."
        npm install

        echo "ğŸ”§ Adding version footer and consistent versioning..."
        # Update server.js to include version footer like frontend
        cat > version-footer-patch.js << 'EOF'
        const fs = require('fs');
        let serverCode = fs.readFileSync('server.js', 'utf8');

        // Update health endpoint with consistent version format
        const healthEndpointPatch = `
        // Health check endpoint with version footer format
        app.get('/health', async (req, res) => {
          res.header('Access-Control-Allow-Origin', '*');
          res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
          res.header('Access-Control-Allow-Headers', 'Origin, X-Requested-With, Content-Type, Accept, Authorization, x-tenant-id, x-user-id');

          const currentTime = new Date();
          const healthStatus = {
            status: 'healthy',
            service: 'GRC AI Platform Backend with Version Footer',
            version: \\`v1.1.0-version-footer-\\${currentTime.toISOString().split('T')[0]} \\${currentTime.toISOString().split('T')[1].split('.')[0]}\\`,
            timestamp: currentTime.toISOString(),
            environment: 'Azure Container Apps',
            corsEnabled: true,
            allowedOrigins: process.env.CORS_ORIGINS || '*',
            deployment: {
              containerName: 'grc-backend-simple',
              version: 'v1.1.0-version-footer',
              buildTime: currentTime.toISOString(),
              features: [
                'Backend version footer matching frontend',
                'Consistent deployment tracking',
                'Health endpoint with version info',
                'Production database connection'
              ]
            },
            database: {
              type: 'PostgreSQL',
              host: process.env.POSTGRES_HOST,
              user: process.env.POSTGRES_USER,
              database: process.env.POSTGRES_DATABASE,
              connected: false
            }
          };

          // Test database connection
          try {
            const db = getDatabase();
            const result = await db.query('SELECT 1 as health_check, version()');
            healthStatus.database.connected = true;
            healthStatus.database.result = result.rows[0];
            healthStatus.database.connectionInfo = 'Connected to ' + process.env.POSTGRES_HOST;
          } catch (error) {
            healthStatus.database.connected = false;
            healthStatus.database.error = error.message;
          }

          res.json(healthStatus);
        });`;

        // Replace the existing health endpoint
        serverCode = serverCode.replace(
          /\\/\\/ Health check endpoint[\\s\\S]*?res\\.json\\(healthStatus\\);\\s*\\}\\);/,
          healthEndpointPatch
        );

        // Add version endpoint for easy checking
        const versionEndpoint = `
        // Version endpoint - simple version check like frontend footer
        app.get('/version', (req, res) => {
          res.header('Access-Control-Allow-Origin', '*');
          const currentTime = new Date();
          const versionInfo = {
            version: \\`Backend v1.1.0-version-footer-\\${currentTime.toISOString().split('T')[0]} \\${currentTime.toISOString().split('T')[1].split('.')[0]}\\`,
            timestamp: currentTime.toISOString(),
            service: 'GRC AI Backend'
          };
          res.json(versionInfo);
        });
        `;

        // Add version endpoint before the health endpoint
        serverCode = serverCode.replace(
          /\\/\\/ Health check endpoint/,
          versionEndpoint + '\\n// Health check endpoint'
        );

        fs.writeFileSync('server.js', serverCode);
        console.log('âœ… Version footer and versioning patch applied');
        EOF

        node version-footer-patch.js

        echo "ğŸ§¹ Cleaning up..."
        rm -rf /tmp/repo version-footer-patch.js

        echo "ğŸ‰ Starting GRC AI Backend v1.1.0 with Version Footer..."
        echo "ğŸ”— Database Host: $POSTGRES_HOST"
        echo "ğŸ”— Database User: $POSTGRES_USER"
        echo "ğŸ”— Database Name: $POSTGRES_DATABASE"
        echo "ğŸ”— CORS Origins: $CORS_ORIGINS"
        echo "ğŸ“Š Version: Backend v1.1.0-version-footer-$(date +'%Y-%m-%d %H:%M:%S')"
        echo "ğŸ·ï¸  Features:"
        echo "    âœ… Backend version footer matching frontend"
        echo "    âœ… Consistent deployment tracking"
        echo "    âœ… Health endpoint with version info"
        echo "    âœ… /version endpoint for quick checks"
        node server.js
    scale:
      minReplicas: 1
      maxReplicas: 2