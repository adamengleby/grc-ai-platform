location: australiasoutheast
name: grc-backend
resourceGroup: rg-grc-ai-platform-syd
type: Microsoft.App/containerApps
properties:
  environmentId: /subscriptions/2e6b5431-6d83-4072-8ccc-86af69cf22b0/resourceGroups/rg-grc-ai-platform-syd/providers/Microsoft.App/managedEnvironments/grc-containerapp-env
  configuration:
    ingress:
      external: true
      targetPort: 8080
  template:
    containers:
    - name: grc-backend
      image: mcr.microsoft.com/azure-functions/node:4-node20-appservice
      resources:
        cpu: 1.0
        memory: 2Gi
        ephemeralStorage: 4Gi
      env:
      - name: NODE_ENV
        value: "production"
      - name: PORT
        value: "8080"
      - name: POSTGRES_HOST
        value: "grc-postgres-syd.postgres.database.azure.com"
      - name: POSTGRES_DATABASE
        value: "grc_platform"
      - name: POSTGRES_USER
        value: "grcadmin"
      - name: POSTGRES_PASSWORD
        value: "GRC2024!Secure"
      - name: CORS_ORIGINS
        value: "https://grc-frontend.calmmeadow-5080198e.australiasoutheast.azurecontainerapps.io,http://localhost:5173,*"
      command:
      - /bin/bash
      args:
      - -c
      - |
        set -e
        echo "ğŸš€ GRC Backend v1.2.0 - CLEAN NAMING (no simple suffix)..."

        # Install required tools
        apt-get update -qq
        apt-get install -y git curl

        # Clone latest code
        echo "ğŸ“¥ Cloning latest backend code..."
        rm -rf /tmp/repo 2>/dev/null || true
        git clone --depth 1 https://github.com/adamengleby/grc-ai-platform.git /tmp/repo
        cd /tmp/repo

        echo "ğŸ“‹ Latest commit:"
        git log -1 --oneline

        # Set up production server
        echo "ğŸšš Setting up clean backend (grc-backend)..."
        mkdir -p /app
        cd /app

        # Copy the server file
        cp /tmp/repo/packages/backend/containerapp-server-v7.js server.js

        # Create production package.json
        cat > package.json << 'EOF'
        {
          "name": "grc-backend",
          "version": "1.2.0",
          "main": "server.js",
          "dependencies": {
            "express": "^4.19.2",
            "cors": "^2.8.5",
            "pg": "^8.11.0"
          }
        }
        EOF

        echo "ğŸ“¦ Installing dependencies..."
        npm install

        echo "ğŸ”§ Applying clean naming and tenant initialization..."
        # Update server.js for clean naming
        cat > clean-naming-patch.js << 'EOF'
        const fs = require('fs');
        let serverCode = fs.readFileSync('server.js', 'utf8');

        // Add tenant initialization function
        const tenantInitCode = `
        // Initialize default tenant if missing (clean backend)
        async function initializeDefaultTenant() {
          try {
            const db = getDatabase();
            const tenantId = '123e4567-e89b-12d3-a456-426614174000';

            // Check if tenant exists
            const existingTenant = await db.query('SELECT id FROM tenants WHERE id = $1', [tenantId]);

            if (existingTenant.rows.length === 0) {
              console.log('ğŸ”§ Creating missing default tenant...');

              // Insert default tenant
              await db.query(\\`
                INSERT INTO tenants (id, name, domain, subscription_tier, is_active, created_at, updated_at)
                VALUES ($1, 'Default Tenant', 'default.local', 'enterprise', true, NOW(), NOW())
              \\`, [tenantId]);

              console.log('âœ… Default tenant created successfully');
            } else {
              console.log('âœ… Default tenant already exists');
            }
          } catch (error) {
            console.error('âŒ Failed to initialize default tenant:', error.message);
          }
        }
        `;

        // Add startup initialization
        const startupInit = `
        // Initialize on startup (clean backend)
        app.listen(PORT, async () => {
          console.log(\\`ğŸš€ GRC Backend (Clean) listening on port \\${PORT}\\`);
          console.log('ğŸ”— Database Host:', process.env.POSTGRES_HOST);
          console.log('ğŸ“Š CORS Origins:', process.env.CORS_ORIGINS);
          console.log('ğŸ·ï¸  Clean URLs: grc-backend (no simple suffix)');

          // Initialize default tenant
          await initializeDefaultTenant();

          console.log('âœ… Clean backend ready - grc-backend v1.2.0');
        });`;

        // Replace the existing app.listen
        serverCode = serverCode.replace(
          /app\.listen\(PORT[^}]*\}\);/,
          startupInit
        );

        // Add the tenant init function before app.listen
        serverCode = serverCode.replace(
          /app\.listen\(PORT/,
          tenantInitCode + '\\n\\napp.listen(PORT'
        );

        // Update health endpoint with clean naming
        const healthEndpointPatch = `
        // Health check endpoint - clean naming
        app.get('/health', async (req, res) => {
          res.header('Access-Control-Allow-Origin', '*');
          res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
          res.header('Access-Control-Allow-Headers', 'Origin, X-Requested-With, Content-Type, Accept, Authorization, x-tenant-id, x-user-id');

          const currentTime = new Date();
          const healthStatus = {
            status: 'healthy',
            service: 'GRC Platform Backend - Clean URLs',
            version: \\`v1.2.0-clean-\\${currentTime.toISOString().split('T')[0]} \\${currentTime.toISOString().split('T')[1].split('.')[0]}\\`,
            timestamp: currentTime.toISOString(),
            environment: 'Azure Container Apps',
            corsEnabled: true,
            allowedOrigins: process.env.CORS_ORIGINS || '*',
            deployment: {
              containerName: 'grc-backend',
              version: 'v1.2.0-clean',
              buildTime: currentTime.toISOString(),
              features: [
                'Clean URLs without simple suffix',
                'Standardized naming: grc-backend',
                'Tenant initialization with UUID support',
                'Frontend integration ready (grc-frontend)',
                'Production database connected'
              ]
            },
            database: {
              type: 'PostgreSQL',
              host: process.env.POSTGRES_HOST,
              user: process.env.POSTGRES_USER,
              database: process.env.POSTGRES_DATABASE,
              connected: false,
              defaultTenantExists: false
            }
          };

          // Test database connection and tenant
          try {
            const db = getDatabase();
            const result = await db.query('SELECT 1 as health_check, version()');
            healthStatus.database.connected = true;
            healthStatus.database.result = result.rows[0];

            // Check default tenant
            const tenantCheck = await db.query('SELECT id FROM tenants WHERE id = $1', ['123e4567-e89b-12d3-a456-426614174000']);
            healthStatus.database.defaultTenantExists = tenantCheck.rows.length > 0;
            healthStatus.database.defaultTenantId = '123e4567-e89b-12d3-a456-426614174000';

          } catch (error) {
            healthStatus.database.connected = false;
            healthStatus.database.error = error.message;
          }

          res.json(healthStatus);
        });`;

        // Replace the existing health endpoint
        serverCode = serverCode.replace(
          /\\/\\/ Health check endpoint[\\s\\S]*?res\\.json\\(healthStatus\\);\\s*\\}\\);/,
          healthEndpointPatch
        );

        fs.writeFileSync('server.js', serverCode);
        console.log('âœ… Clean naming patch applied');
        EOF

        node clean-naming-patch.js

        echo "ğŸ§¹ Cleaning up..."
        rm -rf /tmp/repo clean-naming-patch.js

        echo "ğŸ‰ Starting GRC Backend v1.2.0 - Clean URLs..."
        echo "ğŸ”— Database Host: $POSTGRES_HOST"
        echo "ğŸ”— Database User: $POSTGRES_USER"
        echo "ğŸ”— Database Name: $POSTGRES_DATABASE"
        echo "ğŸ”— CORS Origins: $CORS_ORIGINS"
        echo "ğŸ“Š Version: Backend v1.2.0-clean-$(date +'%Y-%m-%d %H:%M:%S')"
        echo "ğŸ·ï¸  Clean Features:"
        echo "    âœ… Clean URLs: grc-backend (no simple suffix)"
        echo "    âœ… Standardized naming convention"
        echo "    âœ… Tenant initialization ready"
        echo "    âœ… Frontend integration (grc-frontend)"
        node server.js
    scale:
      minReplicas: 1
      maxReplicas: 2