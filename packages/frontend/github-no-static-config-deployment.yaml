properties:
  template:
    containers:
    - image: mcr.microsoft.com/azure-functions/node:4-node20-appservice
      name: grc-frontend-simple
      env:
      - name: NODE_ENV
        value: production
      - name: PORT
        value: "8080"
      - name: VITE_API_BASE_URL
        value: "https://grc-backend-simple.calmmeadow-5080198e.australiasoutheast.azurecontainerapps.io/api/v1"
      command: ["/bin/bash"]
      args:
        - -c
        - |
          set -e
          echo "ğŸš€ Building GRC React Frontend from GitHub Repository (NO STATIC CONFIG VERSION)..."

          # Install required tools
          apt-get update -qq
          apt-get install -y git curl

          # Clone repository
          echo "ğŸ“¥ Cloning repository..."
          git clone https://github.com/adamengleby/grc-ai-platform.git /tmp/repo
          cd /tmp/repo/packages/frontend

          echo "ğŸ“ Frontend directory structure:"
          ls -la

          echo "ğŸ“¦ Installing ALL dependencies (including dev dependencies)..."
          NODE_ENV=development npm install

          echo "ğŸ”§ Temporarily removing staticwebapp config copy to prevent build failure..."
          # Create a modified vite.config.ts without the copy plugin
          cat > vite.config.temp.ts << 'VITE_EOF'
          import { defineConfig } from 'vite'
          import react from '@vitejs/plugin-react'
          import { resolve } from 'path'

          // https://vitejs.dev/config/
          export default defineConfig({
            plugins: [
              react()
            ],
            resolve: {
              alias: {
                '@': resolve(__dirname, './src'),
                '@grc-ai-platform/shared': resolve(__dirname, '../shared/src'),
              },
            },
            server: {
              port: 5173,
              host: true,
              strictPort: true,
              proxy: {
                '/api': {
                  target: 'http://localhost:3005',
                  changeOrigin: true,
                  secure: false
                },
                '/health': {
                  target: 'http://localhost:3005',
                  changeOrigin: true,
                  secure: false
                }
              }
            },
            build: {
              outDir: 'dist',
              sourcemap: true,
            },
          })
          VITE_EOF

          # Backup original and use temp config
          mv vite.config.ts vite.config.orig.ts
          mv vite.config.temp.ts vite.config.ts

          echo "ğŸ”§ Building React application..."
          VITE_API_BASE_URL="https://grc-backend-simple.calmmeadow-5080198e.australiasoutheast.azurecontainerapps.io/api/v1" npm run build

          echo "âœ… Build completed. Checking output..."
          ls -la dist/

          # Set up production app
          echo "ğŸšš Setting up production server..."
          mkdir -p /app
          cp -r dist/* /app/
          cd /app

          echo "ğŸ“„ Production files:"
          ls -la

          # Create package.json
          cat > package.json << 'PACKAGE_EOF'
          {
            "name": "grc-frontend-production",
            "version": "1.0.0",
            "main": "server.js",
            "dependencies": {
              "express": "^4.19.2"
            }
          }
          PACKAGE_EOF

          npm install

          # Create Express server
          cat > server.js << 'SERVER_EOF'
          const express = require('express');
          const path = require('path');
          const app = express();

          // Security headers
          app.use((req, res, next) => {
            res.header('X-Frame-Options', 'DENY');
            res.header('X-Content-Type-Options', 'nosniff');
            res.header('Referrer-Policy', 'strict-origin-when-cross-origin');
            res.header('X-XSS-Protection', '1; mode=block');
            next();
          });

          // Serve static files
          app.use(express.static('.', {
            maxAge: process.env.NODE_ENV === 'production' ? '1d' : 0,
            etag: true,
            lastModified: true
          }));

          // Health check
          app.get('/health', (req, res) => {
            res.json({
              status: 'healthy',
              service: 'GRC React Frontend - GitHub Production Build (NO STATIC CONFIG)',
              version: '2025-09-28-github-no-static-config',
              timestamp: new Date().toISOString(),
              build: 'production-react-github-no-static-config',
              features: {
                'actual-react-app': true,
                'mcp-validation-removed': true,
                'github-build-no-static-config': true,
                'production-build': true
              }
            });
          });

          // API health proxy
          app.get('/api/health', async (req, res) => {
            try {
              const fetch = await import('node-fetch').then(m => m.default || m);
              const response = await fetch('https://grc-backend-simple.calmmeadow-5080198e.australiasoutheast.azurecontainerapps.io/health');
              const data = await response.json();
              res.json({ frontend: 'healthy', backend: data });
            } catch (error) {
              res.status(500).json({ frontend: 'healthy', backend: 'error', error: error.message });
            }
          });

          // SPA fallback
          app.get('*', (req, res) => {
            res.sendFile(path.join(__dirname, 'index.html'));
          });

          const port = process.env.PORT || 8080;
          app.listen(port, () => {
            console.log('ğŸš€ GRC React Frontend (GitHub NO STATIC CONFIG Production Build) on port', port);
            console.log('ğŸ”— API Base URL:', process.env.VITE_API_BASE_URL);
            console.log('âœ… Proper React application with simplified vite config');
            console.log('ğŸ“ Built from GitHub repository without staticwebapp config copy');
            console.log('ğŸ¯ Features: Full React UI, Agent creation without MCP');
          });
          SERVER_EOF

          echo "ğŸ§¹ Cleaning up build artifacts..."
          rm -rf /tmp/repo

          echo "ğŸ‰ Starting GitHub NO STATIC CONFIG React production frontend..."
          node server.js
      resources:
        cpu: 1.25
        memory: 2.5Gi
    scale:
      minReplicas: 1
      maxReplicas: 3
  configuration:
    ingress:
      external: true
      targetPort: 8080