properties:
  template:
    containers:
    - image: mcr.microsoft.com/azure-functions/node:4-node20-appservice
      name: grc-frontend-simple
      env:
      - name: NODE_ENV
        value: production
      - name: PORT
        value: "8080"
      - name: VITE_API_BASE_URL
        value: "https://grc-backend-simple.calmmeadow-5080198e.australiasoutheast.azurecontainerapps.io/api/v1"
      command: ["/bin/sh"]
      args: ["-c", "echo 'Building PROPER GRC React Frontend...' && apt-get update && apt-get install -y git curl && echo 'Cloning repository...' && git clone https://github.com/adamengleby/grc-ai-platform.git /tmp/repo && echo 'Setting up build environment...' && cd /tmp/repo/packages/frontend && echo 'Installing dependencies...' && npm ci --only=production && npm install --only=dev && echo 'Building React application...' && VITE_API_BASE_URL='https://grc-backend-simple.calmmeadow-5080198e.australiasoutheast.azurecontainerapps.io/api/v1' npm run build && echo 'Verifying build output...' && ls -la dist/ && echo 'Setting up production server...' && mkdir -p /app && cp -r dist/* /app/ && cd /app && echo 'Creating package.json...' && cat > package.json << 'EOF'\n{\n  \"name\": \"grc-frontend-production\",\n  \"version\": \"1.0.0\",\n  \"main\": \"server.js\",\n  \"dependencies\": {\n    \"express\": \"^4.19.2\"\n  }\n}\nEOF\nnpm install && echo 'Creating Express server...' && cat > server.js << 'EOF'\nconst express = require('express');\nconst path = require('path');\nconst app = express();\n\n// Security headers\napp.use((req, res, next) => {\n  res.header('X-Frame-Options', 'DENY');\n  res.header('X-Content-Type-Options', 'nosniff');\n  res.header('Referrer-Policy', 'strict-origin-when-cross-origin');\n  res.header('X-XSS-Protection', '1; mode=block');\n  next();\n});\n\n// Serve static files with proper caching\napp.use(express.static('.', { \n  maxAge: process.env.NODE_ENV === 'production' ? '1d' : 0,\n  etag: true,\n  lastModified: true\n}));\n\n// Health check\napp.get('/health', (req, res) => {\n  res.json({\n    status: 'healthy',\n    service: 'GRC React Frontend - ACTUAL PRODUCTION BUILD',\n    version: '2025-09-25-proper-react-production',\n    timestamp: new Date().toISOString(),\n    build: 'production-react-build-proper',\n    features: {\n      'actual-react-app': true,\n      'mcp-validation-removed': true,\n      'proper-production-build': true\n    }\n  });\n});\n\n// API health proxy\napp.get('/api/health', async (req, res) => {\n  try {\n    const fetch = await import('node-fetch').then(m => m.default || m);\n    const response = await fetch('https://grc-backend-simple.calmmeadow-5080198e.australiasoutheast.azurecontainerapps.io/health');\n    const data = await response.json();\n    res.json({ frontend: 'healthy', backend: data });\n  } catch (error) {\n    res.status(500).json({ frontend: 'healthy', backend: 'error', error: error.message });\n  }\n});\n\n// SPA fallback - serve index.html for all routes\napp.get('*', (req, res) => {\n  res.sendFile(path.join(__dirname, 'index.html'));\n});\n\nconst port = process.env.PORT || 8080;\napp.listen(port, () => {\n  console.log('ðŸš€ PROPER GRC React Frontend (Production Build) on port', port);\n  console.log('ðŸ”— API Base URL:', process.env.VITE_API_BASE_URL);\n  console.log('âœ… Actual React application with MCP validation removed');\n  console.log('ðŸŽ¯ Built from source with proper production build process');\n});\nEOF\necho 'Cleaning up build artifacts...' && rm -rf /tmp/repo && echo 'Starting ACTUAL React production frontend...' && node server.js"]
      resources:
        cpu: 1.0
        memory: 2Gi
    scale:
      minReplicas: 1
      maxReplicas: 3
  configuration:
    ingress:
      external: true
      targetPort: 8080