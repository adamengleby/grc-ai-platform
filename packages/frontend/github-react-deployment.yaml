properties:
  template:
    containers:
    - image: mcr.microsoft.com/azure-functions/node:4-node20-appservice
      name: grc-frontend-simple
      env:
      - name: NODE_ENV
        value: production
      - name: PORT
        value: "8080"
      - name: VITE_API_BASE_URL
        value: "https://grc-backend-simple.calmmeadow-5080198e.australiasoutheast.azurecontainerapps.io/api/v1"
      command: ["/bin/sh"]
      args: ["-c", "echo 'ğŸš€ Building GRC React Frontend from GitHub Repository...' && apt-get update && apt-get install -y git curl && echo 'ğŸ“¥ Cloning repository...' && git clone https://github.com/adamengleby/grc-ai-platform.git /tmp/repo && echo 'ğŸ“ Repository structure:' && ls -la /tmp/repo/ && echo 'ğŸ“ Frontend directory:' && ls -la /tmp/repo/packages/frontend/ && echo 'ğŸ”§ Setting up build environment...' && cd /tmp/repo/packages/frontend && echo 'ğŸ“¦ Installing dependencies...' && npm ci && echo 'ğŸ—ï¸ Building React application...' && VITE_API_BASE_URL='https://grc-backend-simple.calmmeadow-5080198e.australiasoutheast.azurecontainerapps.io/api/v1' npm run build && echo 'âœ… Build completed. Verifying output...' && ls -la dist/ && echo 'ğŸ“‹ Build contents:' && find dist -type f -name '*.html' -o -name '*.js' -o -name '*.css' | head -10 && echo 'ğŸšš Setting up production server...' && mkdir -p /app && cp -r dist/* /app/ && cd /app && echo 'ğŸ“„ Checking copied files...' && ls -la && echo 'ğŸ“¦ Creating package.json...' && cat > package.json << 'EOF'\n{\n  \"name\": \"grc-frontend-production\",\n  \"version\": \"1.0.0\",\n  \"main\": \"server.js\",\n  \"dependencies\": {\n    \"express\": \"^4.19.2\"\n  }\n}\nEOF\nnpm install && echo 'âš™ï¸ Creating Express server...' && cat > server.js << 'EOF'\nconst express = require('express');\nconst path = require('path');\nconst app = express();\n\n// Security headers\napp.use((req, res, next) => {\n  res.header('X-Frame-Options', 'DENY');\n  res.header('X-Content-Type-Options', 'nosniff');\n  res.header('Referrer-Policy', 'strict-origin-when-cross-origin');\n  res.header('X-XSS-Protection', '1; mode=block');\n  next();\n});\n\n// Serve static files with proper caching\napp.use(express.static('.', { \n  maxAge: process.env.NODE_ENV === 'production' ? '1d' : 0,\n  etag: true,\n  lastModified: true\n}));\n\n// Health check\napp.get('/health', (req, res) => {\n  res.json({\n    status: 'healthy',\n    service: 'GRC React Frontend - GitHub Production Build',\n    version: '2025-09-25-github-build',\n    timestamp: new Date().toISOString(),\n    build: 'production-react-github',\n    features: {\n      'actual-react-app': true,\n      'mcp-validation-removed': true,\n      'github-source': true,\n      'production-build': true\n    }\n  });\n});\n\n// API health proxy\napp.get('/api/health', async (req, res) => {\n  try {\n    const fetch = await import('node-fetch').then(m => m.default || m);\n    const response = await fetch('https://grc-backend-simple.calmmeadow-5080198e.australiasoutheast.azurecontainerapps.io/health');\n    const data = await response.json();\n    res.json({ frontend: 'healthy', backend: data });\n  } catch (error) {\n    res.status(500).json({ frontend: 'healthy', backend: 'error', error: error.message });\n  }\n});\n\n// SPA fallback - serve index.html for all routes\napp.get('*', (req, res) => {\n  res.sendFile(path.join(__dirname, 'index.html'));\n});\n\nconst port = process.env.PORT || 8080;\napp.listen(port, () => {\n  console.log('ğŸš€ GRC React Frontend (GitHub Production Build) on port', port);\n  console.log('ğŸ”— API Base URL:', process.env.VITE_API_BASE_URL);\n  console.log('âœ… Proper React application with MCP validation removed');\n  console.log('ğŸ“ Built from GitHub repository source');\n  console.log('ğŸ¯ Features: Full React UI, Agent creation without MCP');\n});\nEOF\necho 'ğŸ§¹ Cleaning up build artifacts...' && rm -rf /tmp/repo && echo 'ğŸ‰ Starting GitHub-based React production frontend...' && node server.js"]
      resources:
        cpu: 1.25
        memory: 2.5Gi
    scale:
      minReplicas: 1
      maxReplicas: 3
  configuration:
    ingress:
      external: true
      targetPort: 8080