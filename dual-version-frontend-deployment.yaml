location: australiasoutheast
name: grc-frontend-simple
resourceGroup: rg-grc-ai-platform-syd
type: Microsoft.App/containerApps
properties:
  environmentId: /subscriptions/2e6b5431-6d83-4072-8ccc-86af69cf22b0/resourceGroups/rg-grc-ai-platform-syd/providers/Microsoft.App/managedEnvironments/grc-containerapp-env
  configuration:
    ingress:
      external: true
      targetPort: 8080
  template:
    containers:
    - name: grc-frontend-simple
      image: mcr.microsoft.com/azure-functions/node:4-node20-appservice
      resources:
        cpu: 1.0
        memory: 2Gi
        ephemeralStorage: 4Gi
      env:
      - name: NODE_ENV
        value: "production"
      - name: PORT
        value: "8080"
      - name: VITE_API_BASE_URL
        value: "https://grc-backend-simple.calmmeadow-5080198e.australiasoutheast.azurecontainerapps.io/api/v1"
      command:
      - /bin/bash
      args:
      - -c
      - |
        set -e
        echo "ðŸš€ GRC Frontend v1.0.3 - DUAL VERSION FOOTER..."

        # Install required tools
        apt-get update -qq
        apt-get install -y git curl

        # Clone latest code with dual version footer
        echo "ðŸ“¥ Cloning latest code with dual version footer..."
        git clone https://github.com/adamengleby/grc-ai-platform.git /tmp/repo
        cd /tmp/repo

        echo "ðŸ“‹ Latest commit:"
        git log -1 --oneline

        cd packages/frontend

        echo "ðŸ” Verifying dual version footer update..."
        if grep -q "Frontend v1.0.2-api-fixes" src/app/components/layout/DashboardLayout.tsx && grep -q "Backend {backendVersion}" src/app/components/layout/DashboardLayout.tsx; then
          echo "âœ… Dual version footer updated (Frontend + Backend)"
        else
          echo "âŒ Dual version footer not updated"
        fi

        echo "ðŸ“¦ Installing dependencies..."
        NODE_ENV=development npm install

        echo "ðŸ”§ Building React application v1.0.3..."
        echo "API Base URL: $VITE_API_BASE_URL"

        # Build with explicit environment
        VITE_API_BASE_URL="https://grc-backend-simple.calmmeadow-5080198e.australiasoutheast.azurecontainerapps.io/api/v1" npm run build

        echo "âœ… Build completed."
        ls -la dist/

        # Set up production server
        echo "ðŸšš Setting up production server..."
        mkdir -p /app
        cp -r dist/* /app/
        cd /app

        # Create production package.json
        cat > package.json << 'EOF'
        {
          "name": "grc-frontend-dual-version",
          "version": "1.0.3",
          "main": "server.js",
          "dependencies": {
            "express": "^4.19.2"
          }
        }
        EOF

        npm install

        # Create Express server
        cat > server.js << 'EOF'
        const express = require('express');
        const path = require('path');
        const app = express();

        // Log requests
        app.use((req, res, next) => {
          console.log(`${new Date().toISOString()} ${req.method} ${req.path}`);
          next();
        });

        // Serve static files
        app.use(express.static('.'));

        // Health check with version
        app.get('/health', (req, res) => {
          res.json({
            status: 'healthy',
            service: 'GRC Frontend - v1.0.3 DUAL VERSION FOOTER',
            version: '1.0.3-dual-version-footer',
            timestamp: new Date().toISOString(),
            apiBaseUrl: process.env.VITE_API_BASE_URL,
            features: [
              'Dual version footer (Frontend + Backend)',
              'API URL configuration standardized',
              'All services using consistent URLs',
              'Real-time backend version fetching',
              'Improved deployment visibility'
            ]
          });
        });

        // SPA fallback
        app.get('*', (req, res) => {
          res.sendFile(path.join(__dirname, 'index.html'));
        });

        const port = process.env.PORT || 8080;
        app.listen(port, () => {
          console.log('ðŸš€ GRC Frontend v1.0.3 (DUAL VERSION FOOTER) running on port', port);
          console.log('ðŸ”— API Base URL:', process.env.VITE_API_BASE_URL);
          console.log('âœ… v1.0.3 DUAL VERSION FEATURES:');
          console.log('  âœ… Frontend version with date + time');
          console.log('  âœ… Backend version fetched from health endpoint');
          console.log('  âœ… Dual version display: "Frontend v1.0.3 | Backend version"');
          console.log('  âœ… Improved deployment monitoring and visibility');
        });
        EOF

        echo "ðŸ§¹ Cleaning up..."
        rm -rf /tmp/repo

        echo "ðŸŽ‰ Starting GRC Frontend v1.0.3 with Dual Version Footer..."
        node server.js
    scale:
      minReplicas: 1
      maxReplicas: 2